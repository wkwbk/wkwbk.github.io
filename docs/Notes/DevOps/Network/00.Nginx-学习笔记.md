# Nginx 学习笔记

## 1. Nginx 简介

Nginx (engine x) 是一个高性能的 HTTP 和反向代理 web 服务器，同时也提供了 IMAP/POP3/SMTP 服务。

### 1.1. 特点

- **高并发、高性能**：基于事件驱动的异步非阻塞处理机制，能够支持数百万的并发连接。
- **可扩展性好**：模块化设计，易于扩展。
- **高可靠性**：Master-Worker 架构，一个 worker 进程异常退出，主进程会立刻拉起新的 worker 进程。
- **热部署**：可以在不停止服务的情况下，升级 Nginx。
- **低内存消耗**：相比其他 Web 服务器，内存占用更少。

## 2. 常用功能

### 2.1. 反向代理

反向代理是 Nginx 最常用的功能之一。客户端请求 Nginx，Nginx 再将请求转发给后端的应用服务器。

**优点**：

- **负载均衡**：将请求分发到多个服务器，提高系统的处理能力。
- **隐藏后端服务器**：保护后端服务器的真实 IP 地址。
- **缓存**：缓存静态内容，减轻后端服务器压力。
- **SSL 卸载**：集中处理 HTTPS 请求，后端服务器只需处理 HTTP 请求。

### 2.2. 负载均衡

Nginx 支持多种负载均衡策略：

- **轮询（round-robin）**：默认策略，按时间顺序逐一分配到不同的后端服务器。
- **权重（weight）**：指定轮询几率，`weight` 和访问比率成正比，用于后端服务器性能不均的情况。
- **ip_hash**：每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。
- **fair（第三方）**：按后端服务器的响应时间来分配请求，响应时间短的优先分配。
- **url_hash（第三方）**：按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器。

### 2.3. 动静分离

将动态请求和静态请求分离开。静态资源（如 HTML, CSS, JS, 图片等）由 Nginx 直接处理，动态请求（如 JSP, PHP）则转发给后端的应用服务器处理。

## 3. 基本配置

一个简单的 Nginx 反向代理配置示例：

```nginx
http {
    # 定义一个 upstream 组，包含两个后端服务
    upstream backend_servers {
        server 192.168.1.101:8080;
        server 192.168.1.102:8080;
    }

    server {
        listen 80;
        server_name example.com;

        location / {
            # 将所有请求代理到 upstream 组
            proxy_pass http://backend_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            # 静态文件直接由 Nginx 提供
            root /var/www/static;
            expires 30d;
        }
    }
}
```

### 3.1. 语法解释

Nginx 配置文件由指令和指令块构成。每条指令以分号（;）结尾，指令与参数间以空格分隔。指令块使用大括号（{}）将多条指令组织在一起。

- **`http` 块**：配置 HTTP 服务器的主要指令块，包含多个 `server` 块。
- **`upstream` 块**：定义后端服务器集群，可以在 `proxy_pass` 指令中引用。
- **`server` 块**：配置一个虚拟主机。
  - **`listen`**：指定服务器监听的端口。
  - **`server_name`**：指定服务器的域名。
  - **`location` 块**：根据请求的 URI 来匹配并应用不同的配置。
    - **`proxy_pass`**：将请求转发到指定的后端服务器或 `upstream` 服务器池。
    - **`proxy_set_header`**：修改或添加传递给后端服务器的请求头。
    - **`root`**：指定静态文件的根目录。
    - **`expires`**：设置浏览器缓存的过期时间。

### 3.2. 常用命令

- `nginx`：启动 Nginx
- `nginx -s stop`：快速停止 Nginx
- `nginx -s quit`：优雅地停止 Nginx
- `nginx -s reload`：重新加载配置文件
- `nginx -t`：测试配置文件是否有语法错误

## 4. 常用配置示例

### 4.1. 配置 HTTPS

使用 SSL/TLS 证书为网站启用 HTTPS。

```nginx
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /path/to/your/fullchain.pem;
    ssl_certificate_key /path/to/your/privkey.pem;

    # SSL/TLS 相关配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

    location / {
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 将 HTTP 请求重定向到 HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
```

### 4.2. 启用 Gzip 压缩

通过压缩响应体来减少传输数据的大小，加快页面加载速度。

```nginx
http {
    # ... 其他配置 ...

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ... 其他配置 ...
}
```

### 4.3. 配置浏览器缓存

通过设置 `expires` 头，让浏览器缓存静态资源。

```nginx
server {
    # ... 其他配置 ...

    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        root /var/www/static;
        expires 30d;
        add_header Cache-Control "public";
    }

    # ... 其他配置 ...
}
```

### 4.4. 配置跨域资源共享

当你的前端应用和后端 API 不在同一个域时，需要配置 CORS。

```nginx
server {
    # ... 其他配置 ...

    location /api/ {
        # 允许来自任何域的请求
        add_header 'Access-Control-Allow-Origin' '*';
        # 允许的请求方法
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        # 允许的请求头
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        # 允许浏览器发送凭据（如 cookies）
        add_header 'Access-Control-Allow-Credentials' 'true';

        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        proxy_pass http://backend_api;
    }

    # ... 其他配置 ...
}
```
