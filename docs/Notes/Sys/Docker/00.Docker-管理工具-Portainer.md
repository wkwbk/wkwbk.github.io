# Docker ç®¡ç†å·¥å…· Portainer

Portainer æ˜¯ä¸€æ¬¾å…è´¹ã€å¼€æºçš„ Docker çš„å›¾å½¢åŒ–ç®¡ç†å·¥å…·ï¼Œå…¶èƒ½å¤Ÿæä¾›çŠ¶æ€æ˜¾ç¤ºé¢æ¿ã€åº”ç”¨æ¨¡æ¿å¿«é€Ÿéƒ¨ç½²ã€å®¹å™¨é•œåƒç½‘ç»œæ•°æ®å·çš„åŸºæœ¬æ“ä½œï¼ˆåŒ…æ‹¬ä¸Šä¼ ä¸‹è½½é•œåƒï¼Œåˆ›å»ºå®¹å™¨ç­‰æ“ä½œï¼‰ã€äº‹ä»¶æ—¥å¿—æ˜¾ç¤ºã€å®¹å™¨æ§åˆ¶å°æ“ä½œã€Swarm é›†ç¾¤å’ŒæœåŠ¡ç­‰é›†ä¸­ç®¡ç†å’Œæ“ä½œã€ç™»å½•ç”¨æˆ·ç®¡ç†å’Œæ§åˆ¶ç­‰åŠŸèƒ½ã€‚

## å®‰è£… Docker

### æ›´æ–°ã€å®‰è£…å¿…å¤‡è½¯ä»¶

```bash
apt-get update && apt-get install -y wget vim
```

### Docker å®‰è£…

```bash
wget -qO- get.docker.com | bash
# or
curl -sSL get.docker.com | sh
```

### æŸ¥çœ‹ Docker ç‰ˆæœ¬

```bash
docker -v
```

### å¼€æœºè‡ªåŠ¨å¯åŠ¨

```bash
systemctl enable docker
```

### å¸è½½ Docker

```bash
sudo apt-get purge docker-ce docker-ce-cli containerd.io
```

```bash
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd
```

### Docker-compose å®‰è£…

```bash
curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
docker-compose --version
```

## Docker åŸºæœ¬å‘½ä»¤

```bash
docker ps -a #æŸ¥çœ‹è¿è¡Œçš„é•œåƒè¿›ç¨‹
docker stop <CONTAINER ID> #åœæ­¢è¯¥é•œåƒè¿›ç¨‹
docker start <CONTAINER ID> #å¯åŠ¨è¯¥é•œåƒè¿›ç¨‹
docker rm <CONTAINER ID> #å¸è½½é•œåƒ
docker images #æŸ¥çœ‹å½“å‰ Docker çš„é•œåƒ IMAGE ID
docker rmi <IMAGE ID> #åˆ é™¤é•œåƒ
```

### ä¿®æ”¹ Docker é…ç½®

é™åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé˜²æ­¢ Docker æ—¥å¿—å¡æ»¡ç¡¬ç›˜

```bash
cat > /etc/docker/daemon.json <<EOF
{
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "20m",
        "max-file": "3"
    }
}
EOF
```

ç„¶åé‡å¯ Docker æœåŠ¡

```bash
systemctl restart docker
```

## å®‰è£… Portainer

```bash
# åˆ›å»ºç›®å½•åŒæ—¶è¿›å…¥
mkdir -p /root/docker/portainer && cd $_

# ä¸‹è½½ docker compose é…ç½®æ–‡ä»¶
curl -L https://img.lisir.me/file/docker/portainer/docker-compose.yml

# å¯åŠ¨
docker compose up -d
```

## é…ç½® Docker API

- åœ¨éœ€è¦æ·»åŠ åˆ° Portainer çš„æœåŠ¡å™¨ä¸­å®‰è£… Docker
- å®‰è£…å®Œæˆ Docker åï¼Œä¿®æ”¹ vim /usr/lib/systemd/system/docker.service æš´éœ² docker api æ¥å£

```bash
# å‘½ä»¤æŸ¥çœ‹ docker.service æ–‡ä»¶æ‰€åœ¨è·¯å¾„
systemctl status docker.service

# ç¼–è¾‘ docker.service æ–‡ä»¶
nano /lib/systemd/system/docker.service
```

ä¿®æ”¹é…ç½®é¡¹ExecStartä¸­çš„å€¼ä¸ºï¼š

```bash
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H fd:// --containerd=/run/containerd/containerd.sock
```

> ğŸš« ç›´æ¥å¼€å¯éåŠ å¯†çš„ Docker API æ˜¯ä¸ªéå¸¸å±é™©çš„è¡Œä¸ºï¼

é‡å¯ Docker æœåŠ¡

```bash
# é‡æ–°åŠ è½½æœåŠ¡é…ç½®æ–‡ä»¶
systemctl daemon-reload

# é‡å¯ Docker æœåŠ¡
systemctl restart docker
```

åœ¨ Portainer æ‰€åœ¨æœåŠ¡å™¨æµ‹è¯•æ˜¯å¦å¯è¿æ¥ç›®æ ‡æœåŠ¡å™¨ Docker Api

```bash
# æ ¼å¼ docker -H [ç›®æ ‡æœåŠ¡å™¨IP/å…¬ç½‘IP]:[2375/å¤–ç½‘IPæ˜ å°„çš„ç«¯å£å·] info
docker -H 0.0.0.0:2375 info

# å‡ºç°ä»¥ä¸‹å†…å®¹åˆ™é…ç½®æˆåŠŸ
WARNING: API is accessible on http://0.0.0.0:2375 without encryption.
         Access to the remote API is equivalent to root access on the host. Refer
         to the 'Docker daemon attack surface' section in the documentation for
         more information: https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface
```

å®Œæˆä»¥ä¸Šå†…å®¹åå³å¯åœ¨ Portainer çš„ â€œç«¯ç‚¹/EndPointâ€ èœå•ä¸­ç‚¹å‡» â€œæ·»åŠ ç«¯ç‚¹/Add EndPointâ€, æ¥æ·»åŠ ç›®æ ‡æœåŠ¡å™¨ DockerèŠ‚ç‚¹

## å¼€å¯ TLS è®¤è¯

Docker è‡ªå¸¦ API åŠŸèƒ½ï¼Œæ”¯æŒå¯¹ Docker è¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯é»˜è®¤å¹¶ä¸å¯ç”¨ï¼Œè€Œä¸”ä¸€èˆ¬åœ¨æ²¡æœ‰å¼€å¯åŠ å¯†é€šä¿¡çš„æ—¶å€™ç›´æ¥å¯ç”¨ API ä¼šæœ‰å®‰å…¨é£é™©ã€‚

å› æ­¤æˆ‘ä»¬éœ€è¦å¼€å¯ TLS åŠ å¯†æ¥ä¿éšœ Docker API é€šä¿¡çš„å®‰å…¨æ€§ã€‚é€šè¿‡å¼€å¯ TLS é˜²æ­¢æœªç»è®¸å¯çš„å®¢æˆ·ç«¯è®¿é—®æœåŠ¡ç«¯èŠ‚ç‚¹ï¼Œä¿éšœå…¶ç³»ç»Ÿå®‰å…¨æ€§ã€‚

è€Œ Docker API ä¹Ÿé€‚ç”¨äºåœ¨ä¸€ä¸ª Portainer ç¤ºä¾‹ä¸Šæ¥è¿œç¨‹ç®¡ç†å¤šå°æœºå™¨ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æœ€åˆä½¿ç”¨è¿™ä¸€åŠŸèƒ½çš„åŸå› ã€‚æ¥ä¸‹æ¥å°†ä»‹ç»å¦‚ä½•å®Œæˆ TLS çš„è®¾ç½®ï¼Œæ¥ä¿éšœ Docker API é€šä¿¡çš„å®‰å…¨æ€§ã€‚

### åˆ›å»º TLS è¯ä¹¦

è„šæœ¬é“¾æ¥ï¼š<https://img.lisir.me/file/shell/generate_docker_api_pem.sh>

```bash
# è·å–è„šæœ¬å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
wget https://img.lisir.me/file/shell/generate_docker_api_pem.sh && chmod +x generate_docker_api_pem.sh

# æ‰§è¡Œè„šæœ¬
./generate_docker_api_pem.sh
```

### å¼€å¯ Docker API

ç¼–è¾‘ docker é…ç½®æ–‡ä»¶ï¼š

```bash
vim /lib/systemd/system/docker.service
```

æ‰¾åˆ° ExecStart è¡Œï¼Œåœ¨åé¢æ·»åŠ ä»¥ä¸‹é€‰é¡¹ï¼š

```bash
-H=tcp://0.0.0.0:2376 --tlsverify --tlscacert=/root/.docker/certs/ca-docker_api.pem --tlscert=/root/.docker/certs/server-cert-docker_api.pem --tlskey=/root/.docker/certs/server-key-docker_api.pem
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é‡æ–°åŠ è½½æœåŠ¡å¹¶é‡å¯ Dockerï¼š

```bash
systemctl daemon-reload && service docker restart
```

## é…ç½® Portainer

- æ‰“å¼€ Portainerï¼Œè¿›å…¥ Environmentsã€‚
- ç‚¹å‡»å³ä¸Šè§’çš„ Add environment æ·»åŠ èŠ‚ç‚¹ï¼Œå¹¶åœ¨éšåçš„å‘å¯¼ä¸­é€‰æ‹© APIã€‚
- å°† Environment URL æˆ–è€… Docker API URL ä¸­çš„ç«¯å£ä» 2375 æ”¹ä¸º 2376ã€‚
- ç„¶åå°† TLS çš„ Switch æ‰“å¼€ï¼Œä¸Šä¼ è¯ä¹¦æ–‡ä»¶å³å¯ã€‚
